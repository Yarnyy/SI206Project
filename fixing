import requests
import json
import sqlite3

API_KEY = "160e50d8eefda94217d780b3ad60e5ce"  # Replace with your Last.fm API key
BASE_URL = "http://ws.audioscrobbler.com/2.0/"

def fetch_and_save_top_tracks_from_usa(filename='top_tracks_usa.json'):
    """Fetch the top tracks from the USA and save the data to a JSON file."""
    params = {
        "method": "geo.gettoptracks",
        "country": 'United States',  # Set country to USA
        "api_key": API_KEY,
        "format": "json"
    }

    try:
        # Make the request to the API
        response = requests.get(BASE_URL, params=params)
        
        # Check if the request was successful
        response.raise_for_status()
        
        # Print the raw response to debug
        print("Raw Response:", response.json())
        
        # Parse the JSON response
        data = response.json()
        
        if "tracks" in data:
            # Extract top tracks
            top_tracks = data['tracks']['track']
            
            # Save the top tracks to a JSON file
            with open(filename, 'w', encoding='utf-8') as f:
                json.dump(top_tracks, f, ensure_ascii=False, indent=4)
            
            print(f"Data successfully fetched and saved to {filename}")
        else:
            print("Error: Response does not contain the expected data.")
    
    except requests.exceptions.RequestException as e:
        print(f"Request failed: {e}")
    except ValueError as e:
        print(f"Failed to parse JSON: {e}")
    except Exception as e:
        print(f"An error occurred: {e}")

# Example usage
fetch_and_save_top_tracks_from_usa()